---
layout:     post
title:      Cookie的使用
subtitle:   以Koa演示
date:       2023-09-28
author:     BY
catalog: true
tags:
    - Http
    - Koa
---

后台可以向前台发送Set-Cookie响应头，浏览器收到响应后会设置cookie，测试如下

app.js

```javascript
const Koa = require('koa')
const app = new Koa()

app.use(async ctx => {
    ctx.status = 200
    ctx.set('Access-Control-Allow-Origin', '*');
    ctx.set('Access-Control-Allow-Credentials', 'true');
    ctx.set("WWW-Authenticate", `Basic realm="oauth2/client"`)
    ctx.cookies.set(
        'cid', 
        'hello world',
        {
          domain: 'http://localhost:5173',  // 写cookie所在的域名
          path: '/',       // 写cookie所在的路径
          maxAge: 10 * 60 * 1000, // cookie有效时长
          expires: new Date('2017-02-15'),  // cookie失效时间
          httpOnly: false,  // 是否只用于http请求中获取
          overwrite: false  // 是否允许重写
        }
    )
    ctx.cookies.set('TestCookie2', 'Test12');
    // ctx.cookies.set('jwt', token, { httpOnly: true, secure: true, sameSite: "none", secureProxy: true });
    ctx.body = `hello world`
})

app.listen(3000)

```

首先测试get请求，浏览器直接输入url就是get请求

![](https://s1.locimg.com/2023/09/30/ce69733ccf7bf.png)

可以看到，再次刷新页面浏览器会自动将cookie放在请求头中发送到后台

![](https://s1.locimg.com/2023/09/30/ca64753091527.png)

并且关闭浏览器后再次打开cookie也会保留

**接下来测试post请求**

post请求可以用浏览器原生的form标签来发送，代码如下:

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <form action="http://localhost:3000" method="post">
        <div>
          <label for="say">What greeting do you want to say?</label>
          <input name="say" id="say" value="Hi" />
        </div>
        <div>
          <label for="to">Who do you want to say it to?</label>
          <input name="to" id="to" value="Mom" />
        </div>
        <div>
          <button>Send my greetings</button>
        </div>
      </form>
</body>

</html>
```

可以看到同样存储了cookie，但是会发现有两个问题:

<ol>
    <li>点击按钮提交之后浏览器会刷新到localhost:3000的内容:即后台发送的hello world</li>
    <li>再次发起post请求之后不会携带当前已经存储的cookie</li>
</ol>

针对方法一，可以使用网上的方法，iframe套一层

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <form action="http://localhost:3000" method="post" target="frameName">
        <div>
          <label for="say">What greeting do you want to say?</label>
          <input name="say" id="say" value="Hi" />
        </div>
        <div>
          <label for="to">Who do you want to say it to?</label>
          <input name="to" id="to" value="Mom" />
        </div>
        <div>
          <button>Send my greetings</button>
        </div>
      </form>
      <iframe src="" frameborder="0" name="frameName"></iframe>
</body>

</html>
```

可以看到，现在点击提交之后结果如下:

![](https://s1.locimg.com/2023/09/30/1370604b832e3.png)



针对问题二，应该是由于访问不在同一个域下的api
